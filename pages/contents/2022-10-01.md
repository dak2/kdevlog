---
title: '失敗から学ぶRDBの正しい歩き方'
published_at: '2023-10-01'
updated_at: '2023-09-03'
categories: 'Book'
---

## 感想

アンチパターンとそれに対する対処が書いてあって読みやすかった。

すでに既知のものが多かった。

対処方法は要件によるので一概に正解とは言えないことに注意したい。

## 第2章　失われた事実

- 過去の事実を失わないように、ステータスを変更するのではなく、変更したというレコードを新規追加する
  - 金融系システムなどでよく使われる「打ち消しのINSERT」

事実は残るが、テーブルサイズが増えるので検索性の悪化はトレードオフ

ステータスで絞り込むだろうから、indexを貼っておかないとサイズ増えたら特に検索性悪化する

レコード保持期間を設定しておいて定期的にバッチ削除するか、ステータス遷移をログに出すなどとか考えられる

ログに出してもログサイズが増えるだけなので、同じ問題が発生する

## 第3章　やりすぎたJOIN

この書籍には記載がないが、NLJ関連で調べたことを追記

- NLJの性質上テーブル件数が少ない方が駆動表として決定される。
  - https://zenn.dev/nakunaru/articles/cf663e62fc1a7b
- INNER JOIN の ON句に条件を書いてもあまりパフォーマンス変わらない
  - https://atsuizo.hatenadiary.jp/entry/2016/12/12/163921
  - LEFT OUTER JOINは結果が変わる

2番目は意外でした、操作行数が変わるのでパフォーマンス改善されると聞いていたので。

LEFT OUTER JOINはON句の条件に当てはまるものと、外部結合的に当てはまらないものを両方取得するので結局全行取得になる。

WHERE句で条件を書くと、LEFT OUTER JOINで返ってきた結果を絞り込む形になるので、ON句で条件を書く場合と結果が変わる。

##
